# Epic Cardio biosensor GUI

This application is designed to automate the evaluation of Corning Epic biosensor records. The code is implemented in MATLAB, but there is available .exe version that does not require installation of the full MATLAB application. 

## Installation
To install standalone application, run CardioAlpha_Installer.exe. Since the application uses MATLAB this also installs MATLAB Runtime(compact version of MATLAB for execution only). 

For running the application in MATLAB the following versions and packages are required:
* MATLAB version : R2019b
* Dependencies : 
  * Mapping Toolbox
  * Image Processing Toolbox
  * Statistics and Machine Learning Toolbox
  * Curve Fitting Toolbox

Currently the program requires input files acquired from the Imager Beta software, which is available on this link: LINK

## Flowchart of the program
![flowchart](/Cardio_GUI_flowchart.png)

## How to use

A tutorial video of the correct evaluation workflow is available here:

### Preprocessing raw measurement data in Imager Beta

A tutorial video of the correct Imager Beta preprocessing workflow is available here: https://drive.google.com/open?id=1E1asLDJbOXjp92LhkXM5nugWVRFMESXq

Raw measurement files are generated by measurement software in the following structure: 
- 'DMR' folder with numbered files containing measurement data
- '240x320x4x3_test_WL_Power' file
- 'test_avg' file

Open the Imager Beta software and load the file with name '240x320x4x3_test_WL_Power'. The loaded measurements sensor image will appear. To make an exported datafile compatible with the Cardio GUI software, we should select a rectangular area from the Imager Beta program. We can do this with the rectangular selection tool while selecting the region of interest while holding down the SHIFT key. After selection click on the well with the black arrow tool (a white border will appear), then click on 'Set ROI'. Pixelwise measurement data can be acquired by clicking on the 'Pixel analysis' button, after which the selected areas data will be shown in a new window. Click on 'Export All' button to export the measurement's data in an '.xls' format. This format contains the data such that the first column of the matrix contains the timesteps in seconds and each row holds the data of the pixel values(as wavelength-shift or wavelength) for the given timestep. This '.xls' file should be converted to '.xlsx' to be a valid input fo the Cardio GUI software.

### Loading measurement data with Cardio GUI

By clicking on 'Browse...' button, select the previously exported and converted '.xlsx' file for loading. Set the correct raw pixel size of the instrument that the measurement data was acquired for. This ensures that the calculated areas will be correct.
- for EPIC Cardio, pixel_size = 25um
- for EPIC BT, pixel_size = 80um

Depending on whether we are using wavelength-shift(WS) or wavelength(WL) data as input, select the slider value accordingly.

### Preprocessing with Cardio GUI

#### Drift correction
As the measurement could contain artefacts and baseline drift, first we need to correct these. The software offers two main approaches of correction:
- "background correction" selects areas of the sensor that do not contain cell signals, and subtracts the average signal of these from the whole measurement. This method can robustly eliminate non-cell related signals from the measurement data, and should be the preferred evaluation method. It has two variants: 'global background correction' which calculates the correction signal as the whole sensors background average and 'local background correction' which corrects the signal locally in the close vicinity of each cell. The latter method should give better results when the background is inhomogeneous or in case we are dealing with wide range of signal strengths in a single measurement. Otherwise the former method should give good results with a smaller computational cost.
- "model based correction" applies linear correction to the data by fitting a linear model to the initial portion of the measurement (defined by the user). This approach can be used if the background can not be determined straigforward eg. in case of a fully covered sensor, where the only source of information about the drift is the baseline section. Otherwise background based methods should be preferred over this approach.

#### Interpolation
The softwer offers the possibility to apply spatial interpolation on the data, for the reason of smoothing the signal of area-related measures such as IWS, average-WS and Area of single cells. Note that this could introduce deviences in calculated cell area compared to non-interpolated data depending on the level of evaluation threshold (see Evaluation)

### Detection and selection of cells
Detection threshold should be given for the last frame of measurement such that all the cells are detected (indicated by red dots). After that, in filter cells tab the relevant cells can be selected.

### Evaluation
The single cell signals can be acquired by two thresholding methods:
- 'global thresholding' method determines the cell boundaries based on the user-defined global threshold value. In each timestep the cell area is determined as the above threshold regions. Drawback of this method is that we must introduce an ad-hoc parameter of the evaluation threshold, which seems to be cell specific and dependent on the adhesion strength.
- 'unique thresholding' method determines the cell boundaries based on max-WS signal of each cell. The equation that calculates the cell-specific threshold is described in https://www.nature.com/articles/s41598-019-56898-7. Drawback of this method is that cells with small signals are assinged with too small areas (due to the near linear start of the mentioned calibartion equation).
There is no preferred method, however global therhsholding gives seemingly better results on small signals(<500pm).

### Visualization of single-cell data
After evaluation is finished, 'Single cell data' tab shows the the following single cell modalities:
- maximalWS: the maximal wavelength-shift pixel value in each timestep of the above threshold pixels
- averageWS: the average wavelength-shift of the cell constituent pixels in each timestep
- area: the area of the cell constituent pixels in each timestep
- IWS: the surface integral of wavelength shift; calculated as averageWS * area

Sigmoid fitting is possible in the 'Sigmoid fit' panel, where each single cell signal (in each modality) is fitted with a 4 parameter sigmoid function: f = @(p,xdata) A /(1+exp(-r * (xdata-t0))) + A0 , where A is the amplitude, r is the rate, t0 is the time of inflexion point and A0 is the baseline.

### Exporting single-cell data
By selecting the relevant modalities and fitted parameters the software exports the data to .xlsx files in the following format:
- For modalities the first column and row containts the timesteps(in seconds) and cell labels respectively. The following entries contain the calculated modality data for each timestep/cell
- For sigmoid fit parameters the exported file contains [cellID, amplitude, rate, offset, baseline] parameters in each columns

## Possible development areas
- RAW evaluation: currently the Imager Beta preprocessing steps are necessary beacuse we can not interpret the data in the raw DMR files in a meaningful way. This step involves repetitive manual work, that could be otherwise easily automated, thus speeding up the evaluation process.
- .xls-.xlsx conversion and loading: additional easily automatable process is the conversion of files. It should be investigated which file format is the most effective for MATLAB read-in. The 'readtable()' function can take long to load the data (depending on the computer resources).
- Bottlenecks of evaluation speed: Currently these methods are the slowest/most computationally costly: Local background correction, detection and evaluation. Check how these functions could be optimized
- Wrapper for whole measurement evaluation: it would greatly imporve convenience to evaluate a whole folder of Imager Beta exported measurements, with predefined parameters for the relevant evaluation steps. With this approach however would come the risk of inappropriate evaluation, so suitable metrics and quality checks should be incorporated for the wrapper program output.
